<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Necesse Survival - HoangKun</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'VT323', monospace; overflow: hidden; }

        /* --- PHẦN 1: GIAO DIỆN SẢNH (LOBBY) --- */
        #lobby-container {
            width: 100vw; height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                        url('https://hoanghamobile.com/tin-tuc/wp-content/uploads/2024/11/pixels-game-thumb.jpg');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center;
        }
        .content-area { width: 90%; max-width: 1200px; height: 85%; position: relative; }
        .header h1 { font-size: 4.5rem; color: #fff; text-shadow: 4px 4px 0px #000; }
        .menu-options { position: absolute; bottom: 20px; right: 0; display: flex; flex-direction: column; gap: 10px; }
        .name-input { width: 250px; padding: 10px; background: #3d251e; border: 4px solid #8d6e63; color: #f4e4bc; font-family: 'VT323'; font-size: 1.5rem; text-align: center; }
        .wood-button {
            width: 250px; height: 60px; background: #8d6e63; border: 4px solid #5d4037; border-bottom: 8px solid #2d1b16;
            color: #f4e4bc; font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .wood-button:active { transform: translateY(4px); border-bottom-width: 4px; }

        /* --- PHẦN 2: GIAO DIỆN TRONG GAME --- */
        #gameCanvas { display: none; position: fixed; inset: 0; }
        #ui-layer { display: none; }
        #pause-btn { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: #8d6e63; border: 3px solid #3d251e; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100; font-size: 1.5rem; }
        
        #pause-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 1000; justify-content: center; align-items: center; flex-direction: column;
        }

        #loading-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 2000; flex-direction: column; justify-content: center; align-items: center; color: #f4e4bc;
        }
        .pixel-spinner { width: 50px; height: 50px; border: 6px solid #5d4037; border-top-color: #f4e4bc; animation: spin 1s steps(8) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body onclick="initAudio()">

    <audio id="bgMusic" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg"></audio>

    <div id="lobby-container">
        <div class="content-area">
            <div class="header">
                <h1>NECESSE SURVIVAL</h1>
                <p style="font-size: 2rem; color: #f4e4bc;">v1.0 by HoangKun</p>
            </div>
            <div class="menu-options">
                <input type="text" id="charName" class="name-input" placeholder="TÊN CỦA BẠN..." maxlength="12">
                <div class="wood-button" onclick="connectWorld()">VÀO GAME</div>
                <div class="wood-button" onclick="location.reload()">THOÁT</div>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="pixel-spinner"></div>
        <div style="font-size: 2.5rem; margin-top: 20px;">ĐANG TẢI THẾ GIỚI...</div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="pause-btn" onclick="togglePause()">||</div>

    <div id="pause-modal">
        <div style="background: #5d4037; padding: 40px; border: 6px solid #3d251e; text-align: center; color: #f4e4bc;">
            <h2 style="font-size: 3rem; margin-bottom: 20px;">TẠM DỪNG</h2>
            <div class="wood-button" onclick="togglePause()" style="margin: 10px auto;">TIẾP TỤC</div>
            <div class="wood-button" onclick="location.reload()" style="background: #e74c3c; margin: 10px auto;">VỀ SẢNH</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgMusic = document.getElementById('bgMusic');

        // 1. TẢI ẢNH (Quan trọng: Phải đúng tên file)
        const imgP = new Image(); imgP.src = 'nhanvat.png';
        const imgG = new Image(); imgG.src = 'co.png';
        const imgT = new Image(); imgT.src = 'cay.png';

        let gameActive = false;
        let isPaused = false;
        let audioStarted = false;

        // 2. KHỞI TẠO ĐỐI TƯỢNG
        const player = {
            x: 2000, y: 2000,
            speed: 5,
            dir: 0, // 0: Down, 1: Up, 2: Left, 3: Right
            frameX: 0,
            isWalking: false,
            name: ""
        };

        const trees = [];
        for(let i=0; i<30; i++) {
            trees.push({ x: Math.random()*4000, y: Math.random()*4000 });
        }

        const keys = {};

        // 3. LOGIC HỆ THỐNG
        function initAudio() {
            if(!audioStarted) {
                bgMusic.volume = 0.3;
                bgMusic.play();
                audioStarted = true;
            }
        }

        function connectWorld() {
            player.name = document.getElementById('charName').value || "Hành Giả";
            document.getElementById('loading-overlay').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('lobby-container').style.display = 'none';
                canvas.style.display = 'block';
                document.getElementById('pause-btn').style.display = 'flex';
                gameActive = true;
                gameLoop();
            }, 1500);
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pause-modal').style.display = isPaused ? 'flex' : 'none';
        }

        window.onkeydown = (e) => { 
            keys[e.code] = true; 
            if(e.code === 'Escape' && gameActive) togglePause();
        };
        window.onkeyup = (e) => keys[e.code] = false;

        // 4. VÒNG LẶP CHÍNH
        function update() {
            if(isPaused) return;
            player.isWalking = false;

            if(keys['KeyW']) { player.y -= player.speed; player.dir = 1; player.isWalking = true; }
            if(keys['KeyS']) { player.y += player.speed; player.dir = 0; player.isWalking = true; }
            if(keys['KeyA']) { player.x -= player.speed; player.dir = 2; player.isWalking = true; }
            if(keys['KeyD']) { player.x += player.speed; player.dir = 3; player.isWalking = true; }

            if(player.isWalking) {
                player.frameX = (Math.floor(Date.now() / 200) % 2);
            } else {
                player.frameX = 0;
            }
        }

        function draw() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const camX = player.x - canvas.width/2;
            const camY = player.y - canvas.height/2;

            // Vẽ nền cỏ
            for(let x=0; x<4000; x+=256) {
                for(let y=0; y<4000; y+=256) {
                    ctx.drawImage(imgG, x - camX, y - camY, 256, 256);
                }
            }

            // Vẽ cây
            trees.forEach(t => {
                ctx.drawImage(imgT, t.x - camX, t.y - camY, 120, 160);
            });

            // Vẽ nhân vật (Cắt đúng 350x350 từ Sprite Sheet)
            let sx = player.frameX * 350;
            let sy = player.dir * 350;
            ctx.drawImage(imgP, sx, sy, 350, 350, canvas.width/2 - 40, canvas.height/2 - 50, 80, 100);

            // Vẽ tên
            ctx.fillStyle = "white";
            ctx.font = "24px VT323";
            ctx.textAlign = "center";
            ctx.fillText(player.name, canvas.width/2, canvas.height/2 - 60);
        }

        function gameLoop() {
            if(!gameActive) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
