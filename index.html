<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Necesse Survival Pro - HoangKun</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- CSS: GIAO DIỆN CHI TIẾT --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: #1a1a1a; 
            font-family: 'VT323', monospace; 
            overflow: hidden; 
            touch-action: none; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Lobby chính */
        #lobby-container {
            width: 100vw; 
            height: 100vh; 
            position: fixed; 
            top: 0; left: 0;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://hoanghamobile.com/tin-tuc/wp-content/uploads/2024/11/pixels-game-thumb.jpg');
            background-size: cover; 
            background-position: center; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 100;
        }

        .main-panel {
            background: #5d4037;
            border: 6px solid #3d251e;
            padding: 40px;
            color: #f4e4bc;
            box-shadow: 12px 12px 0px #000;
            text-align: center;
            width: 400px;
        }

        .game-title {
            font-size: 4.5rem;
            color: #fff;
            text-shadow: 5px 5px 0px #2d1b16;
            margin-bottom: 20px;
        }

        /* Nút bấm kiểu gỗ */
        .wood-btn {
            width: 100%;
            height: 65px;
            background: #8d6e63;
            border: 4px solid #5d4037;
            border-bottom: 8px solid #2d1b16;
            color: #f4e4bc;
            font-size: 2.2rem;
            cursor: pointer;
            text-shadow: 2px 2px 0px #000;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.1s;
        }
        .wood-btn:hover { background: #a1887f; }
        .wood-btn:active { transform: translateY(6px); border-bottom-width: 2px; }

        .name-input {
            width: 100%;
            padding: 15px;
            background: #3d251e;
            color: #f4e4bc;
            border: 4px solid #8d6e63;
            font-family: 'VT323';
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Canvas và UI trong game */
        #game-canvas {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10;
            image-rendering: pixelated;
        }

        #ui-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 50;
            pointer-events: none;
        }

        /* Thanh trạng thái HUD */
        .hud-stats {
            pointer-events: auto;
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(61, 37, 30, 0.9);
            border: 4px solid #f4e4bc;
            padding: 20px;
            color: #f4e4bc;
            font-size: 1.8rem;
            box-shadow: 6px 6px 0px #000;
        }

        .hp-container {
            width: 200px;
            height: 15px;
            background: #2d1b16;
            border: 2px solid #fff;
            margin-top: 10px;
        }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; transition: width 0.3s; }

        /* Điều khiển Mobile xịn */
        .joy-container {
            pointer-events: auto;
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 130px;
            height: 130px;
            background: rgba(255, 255, 255, 0.1);
            border: 4px solid rgba(255,255,255,0.5);
            border-radius: 50%;
        }
        .joy-stick {
            position: absolute;
            top: 50%; left: 50%;
            width: 55px; height: 55px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .btn-action {
            pointer-events: auto;
            position: absolute;
            bottom: 60px;
            right: 60px;
            width: 110px;
            height: 110px;
            background: #e67e22;
            border: 6px solid #d35400;
            border-radius: 50%;
            color: #fff;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 0 #a04000;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 2px 0 #a04000; }

        /* Cài đặt */
        #settings-menu {
            display: none;
            position: fixed;
            z-index: 200;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body onclick="handleFirstClick()">

    <audio id="msc-bg" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>
    <audio id="snd-hit"><source src="https://www.fesliyanstudios.com/play-mp3/6"></audio>

    <div id="lobby-container">
        <div class="main-panel">
            <h1 class="game-title">NECESSE PRO</h1>
            <p style="font-size: 1.5rem; margin-bottom: 20px;">PHIÊN BẢN SINH TỒN 2026</p>
            
            <input type="text" id="input-name" class="name-input" placeholder="TÊN NHÂN VẬT..." maxlength="10">
            
            <div class="wood-btn" onclick="initGame('new')">BẮT ĐẦU MỚI</div>
            <div class="wood-btn" onclick="initGame('load')">TIẾP TỤC</div>
            <div class="wood-btn" onclick="toggleSettings()">CÀI ĐẶT</div>
        </div>
    </div>

    <div id="settings-menu" class="main-panel">
        <h2 style="font-size: 3rem; border-bottom: 4px solid #3d251e;">CÀI ĐẶT</h2>
        <div style="margin: 30px 0; text-align: left;">
            <label style="font-size: 1.8rem;">ÂM LƯỢNG NHẠC:</label>
            <input type="range" id="vol-music" min="0" max="1" step="0.1" value="0.5" style="width: 100%; margin-top: 10px;">
        </div>
        <div class="wood-btn" style="height: 50px;" onclick="toggleSettings()">LƯU & ĐÓNG</div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="ui-overlay">
        <div class="hud-stats">
            <div id="display-name" style="border-bottom: 2px solid #8d6e63; margin-bottom: 5px;">PLAYER</div>
            <div>VÀNG: <span id="val-gold" style="color:#ffeb3b">0</span></div>
            <div>GỖ: <span id="val-wood" style="color:#4db6ac">0</span></div>
            <div class="hp-container"><div id="hp-fill"></div></div>
        </div>

        <div style="position: absolute; top: 25px; right: 25px; pointer-events: auto;">
            <button class="wood-btn" style="width: 100px; height: 40px; font-size: 1.2rem;" onclick="saveGame()">LƯU</button>
        </div>

        <div class="joy-container" id="joyBase">
            <div class="joy-stick" id="joyStick"></div>
        </div>

        <div class="btn-action" onmousedown="playerHit()" ontouchstart="playerHit()">HIT</div>
    </div>

    <script>
        /* --- KHAI BÁO BIẾN TOÀN CỤC (GLOBAL VARIABLES) --- */
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const mscBg = document.getElementById('msc-bg');
        const sndHit = document.getElementById('snd-hit');

        // Hình ảnh nhân vật & cây (Mã hóa Base64 để tránh lỗi file)
        const imgPlayer = new Image(); 
        imgPlayer.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QYXCxwS6O9vFAAABWhJREFUeNrtnU2O3DAMhOfmInmYvOfIe868N0fJM6SAsYFis9kkRVL9fIDBAtX9S7KpYvXp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6fmf0mOHePv27YfD4fB9o8c2R9S/v7//fDgcfrx+/frbLp/T6/W6/f79++fr169/7fI5PdIHAoAf0gMAIAAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsE/gG56uU7+ZidVwAAAABJRU5ErkJggg==';
        const imgTree = new Image(); 
        imgTree.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QYXCxw0W9YFvQAAAm9JREFUeNrtmztuwkAQhr8dEkU6SAs9AnIEpEInpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnv8H/gN0yYf1RkCg1gAAAABJRU5ErkJggg==';

        // Thông số thế giới và người chơi
        let game = {
            active: false,
            worldSize: 4000,
            trees: [],
            keys: {},
            joy: { x: 0, y: 0, active: false }
        };

        let player = {
            wx: 2000, wy: 2000, // Vị trí trong thế giới (World X, World Y)
            name: "",
            gold: 0, wood: 0, hp: 100,
            speed: 6,
            dir: 'down',
            isHitting: false
        };

        /* --- HỆ THỐNG XỬ LÝ SỰ KIỆN --- */
        function handleFirstClick() {
            if(mscBg.paused) { mscBg.volume = 0.4; mscBg.play(); }
        }

        function toggleSettings() {
            let m = document.getElementById('settings-menu').style;
            m.display = (m.display === 'block') ? 'none' : 'block';
        }

        function initGame(mode) {
            // Load dữ liệu nếu chọn Continue
            if(mode === 'load') {
                let saved = localStorage.getItem('necesse_hoangkun_save');
                if(saved) {
                    let d = JSON.parse(saved);
                    player.gold = d.gold; player.wood = d.wood; player.name = d.name;
                } else {
                    alert("Không có file đã lưu!"); return;
                }
            } else {
                player.name = document.getElementById('input-name').value || "HoangKun";
            }

            document.getElementById('lobby-container').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui-overlay').style.display = 'block';

            // Tạo rừng cây ngẫu nhiên (120 cây)
            for(let i=0; i<120; i++) {
                game.trees.push({
                    x: Math.random() * game.worldSize,
                    y: Math.random() * game.worldSize,
                    hp: 40
                });
            }

            resizeCanvas();
            game.active = true;
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        function saveGame() {
            let data = { gold: player.gold, wood: player.wood, name: player.name };
            localStorage.setItem('necesse_hoangkun_save', JSON.stringify(data));
            alert("Đã lưu tiến trình!");
        }

        /* --- ĐIỀU KHIỂN JOYSTICK --- */
        const jBase = document.getElementById('joyBase');
        const jStick = document.getElementById('joyStick');

        jBase.addEventListener('touchstart', (e) => {
            game.joy.active = true;
            e.preventDefault();
        });

        window.addEventListener('touchmove', (e) => {
            if(!game.joy.active) return;
            let t = e.touches[0];
            let rect = jBase.getBoundingClientRect();
            let centerX = rect.left + rect.width/2;
            let centerY = rect.top + rect.height/2;
            
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;
            let dist = Math.min(Math.sqrt(dx*dx + dy*dy), 65);
            let angle = Math.atan2(dy, dx);

            game.joy.x = Math.cos(angle) * (dist/65);
            game.joy.y = Math.sin(angle) * (dist/65);

            jStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
        });

        window.addEventListener('touchend', () => {
            game.joy.active = false;
            game.joy.x = 0; game.joy.y = 0;
            jStick.style.transform = 'translate(-50%, -50%)';
        });

        /* --- HÀNH ĐỘNG ĐÁNH (HIT) --- */
        function playerHit() {
            if(!game.active) return;
            sndHit.currentTime = 0; sndHit.play();
            player.isHitting = true;

            // Kiểm tra va chạm với từng cái cây
            game.trees.forEach((tree, index) => {
                let d = Math.hypot(player.wx - tree.x, player.wy - tree.y);
                if(d < 90) { // Phạm vi đánh 90px
                    tree.hp -= 20;
                    if(tree.hp <= 0) {
                        game.trees.splice(index, 1);
                        player.wood += 5; player.gold += 10;
                        updateHUD();
                    }
                }
            });

            setTimeout(() => { player.isHitting = false; }, 150);
        }

        /* --- VÒNG LẶP GAME --- */
        window.onkeydown = (e) => { game.keys[e.code] = true; };
        window.onkeyup = (e) => { game.keys[e.code] = false; };

        function updateHUD() {
            document.getElementById('display-name').innerText = player.name;
            document.getElementById('val-gold').innerText = player.gold;
            document.getElementById('val-wood').innerText = player.wood;
            document.getElementById('hp-fill').style.width = player.hp + "%";
        }

        function moveLogic() {
            let moveX = game.joy.x;
            let moveY = game.joy.y;

            // Phím bấm PC
            if(game.keys['KeyW']) moveY = -1;
            if(game.keys['KeyS']) moveY = 1;
            if(game.keys['KeyA']) moveX = -1;
            if(game.keys['KeyD']) moveX = 1;

            if(moveX !== 0 || moveY !== 0) {
                // Chuẩn hóa tốc độ
                let m = Math.sqrt(moveX*moveX + moveY*moveY);
                player.wx += (moveX/m) * player.speed;
                player.wy += (moveY/m) * player.speed;

                // Giới hạn biên thế giới
                player.wx = Math.max(0, Math.min(game.worldSize, player.wx));
                player.wy = Math.max(0, Math.min(game.worldSize, player.wy));

                // Hướng mặt
                if(moveX > 0) player.dir = 'right';
                else if(moveX < 0) player.dir = 'left';
            }
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Tính toán Camera (Để người chơi luôn ở giữa)
            let camX = player.wx - canvas.width / 2;
            let camY = player.wy - canvas.height / 2;

            // 1. Vẽ nền cỏ (Dùng màu xanh rừng)
            ctx.fillStyle = '#2d6a4f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Vẽ lưới ô đất (Trang trí)
            ctx.strokeStyle = 'rgba(0,0,0,0.05)';
            for(let i = -camX % 100; i < canvas.width; i += 100) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
            for(let j = -camY % 100; j < canvas.height; j += 100) {
                ctx.beginPath(); ctx.moveTo(0, j); ctx.lineTo(canvas.width, j); ctx.stroke();
            }

            // 3. Vẽ cây cối
            game.trees.forEach(t => {
                // Chỉ vẽ nếu cây nằm trong màn hình để mượt hơn
                if(t.x > camX - 100 && t.x < camX + canvas.width + 100 &&
                   t.y > camY - 100 && t.y < camY + canvas.height + 100) {
                    ctx.drawImage(imgTree, t.x - camX - 32, t.y - camY - 64, 64, 85);
                }
            });

            // 4. Vẽ người chơi (Sử dụng Sprite Sheet Logic)
            let spriteX = 0; 
            let spriteY = 0; 

            if(player.dir === 'left') spriteY = 256; 
            if(player.dir === 'right') spriteY = 384;
            if(player.isHitting) spriteX = 256; // Frame đang đánh

            ctx.drawImage(
                imgPlayer, 
                spriteX, spriteY, 128, 128, // Cắt ảnh từ sprite
                canvas.width/2 - 45, canvas.height/2 - 45, // Vị trí giữa màn hình
                90, 90 // Kích thước hiển thị
            );

            // Tên người chơi trên đầu
            ctx.fillStyle = "white";
            ctx.font = "24px VT323";
            ctx.textAlign = "center";
            ctx.fillText(player.name, canvas.width/2, canvas.height/2 - 55);
        }

        function gameLoop() {
            if(!game.active) return;
            moveLogic();
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);

    </script>
</body>
</html>
