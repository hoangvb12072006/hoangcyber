<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Necesse Pixel - Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; font-family: 'VT323', monospace; overflow: hidden; touch-action: none; }
        
        /* MENU CH√çNH */
        #lobby {
            width: 100vw; height: 100vh; position: fixed; inset: 0;
            background: #2d6a4f; display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .panel { background: #5d4037; border: 6px solid #3d251e; padding: 25px; color: #f4e4bc; box-shadow: 8px 8px 0px #000; text-align: center; min-width: 300px; }
        .btn { background: #8d6e63; border: 4px solid #3d251e; border-bottom: 8px solid #2d1b16; color: #f4e4bc; padding: 10px; font-size: 1.8rem; cursor: pointer; margin-top: 10px; display: block; width: 100%; font-family: 'VT323'; }
        .btn:active { transform: translateY(4px); border-bottom-width: 4px; }

        /* GAME */
        #game-canvas { display: none; background: #3a5a40; position: fixed; inset: 0; z-index: 10; image-rendering: pixelated; }

        /* UI */
        #ui { display: none; position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        .hud { pointer-events: auto; position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; color: #fff; border: 3px solid #f4e4bc; font-size: 1.2rem; }
        .minimap { position: absolute; top: 10px; right: 10px; width: 120px; height: 120px; background: rgba(0,0,0,0.5); border: 2px solid #fff; }
        
        #crafting { pointer-events: auto; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; background: rgba(0,0,0,0.8); padding: 8px; border: 2px solid #8d6e63; }
        .c-item { background: #5d4037; border: 2px solid #f4e4bc; color: #fff; padding: 5px; font-size: 0.9rem; cursor: pointer; text-align: center; }

        /* MOBILE CONTROLS */
        .joy-base { pointer-events: auto; position: absolute; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #fff; }
        .joy-stick { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #fff; border-radius: 50%; transform: translate(-50%,-50%); }
        .hit-btn { pointer-events: auto; position: absolute; bottom: 40px; right: 40px; width: 85px; height: 85px; background: #e67e22; border: 5px solid #d35400; border-radius: 50%; color: #fff; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 6px 0 #a04000; }
        .hit-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #a04000; }
    </style>
</head>
<body onclick="initSfx()">

    <audio id="bgM" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>
    <audio id="hitS"><source src="https://www.fesliyanstudios.com/play-mp3/6"></audio>

    <div id="lobby">
        <div class="panel">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">NECESSE PRO v2</h1>
            <input type="text" id="pName" style="width:100%; padding:10px; text-align:center; margin-bottom:10px;" placeholder="T√äN NH√ÇN V·∫¨T...">
            <button class="btn" onclick="start()">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn" onclick="saveGame()">L∆ØU GAME</button>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="ui">
        <div class="hud">
            <div>üí∞ V√†ng: <span id="g-v">0</span></div>
            <div>üå≤ G·ªó: <span id="w-v">0</span> | ü™® ƒê√°: <span id="s-v">0</span></div>
            <div style="color: #ffeb3b;">‚öîÔ∏è: <span id="t-v">Tay kh√¥ng</span></div>
            <div style="width: 120px; height: 8px; background: #3d251e; margin-top: 5px;"><div id="hp-bar" style="width: 100%; height: 100%; background: #ff4d4d;"></div></div>
        </div>

        <div id="crafting">
            <div class="c-item" onclick="craft('axe')">R√åU<br>(15 G·ªó)</div>
            <div class="c-item" onclick="craft('sword')">KI·∫æM<br>(10G-10ƒê)</div>
        </div>

        <div class="minimap"><canvas id="m-can" width="120" height="120"></canvas></div>
        <div class="joy-base" id="jb"><div class="joy-stick" id="js"></div></div>
        <div class="hit-btn" onmousedown="hit()" ontouchstart="hit()">HIT</div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const mCtx = document.getElementById('m-can').getContext('2d');

        // V·∫º H√åNH ·∫¢NH B·∫∞NG CODE (ƒê·ªÉ kh√¥ng bao gi·ªù b·ªã l·ªói link ·∫£nh)
        const imgP = new Image(); // Nh√¢n v·∫≠t (B·∫°n c√≥ th·ªÉ thay src b·∫±ng base64 c·ªßa ·∫£nh b·∫°n)
        imgP.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QYXCxwS6O9vFAAABWhJREFUeNrtnU2O3DAMhOfmInmYvOfIe868N0fJM6SAsYFis9kkRVL9fIDBAtX9S7KpYvXp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6enp6fmf0mOHePv27YfD4fB9o8c2R9S/v7//fDgcfrx+/frbLp/T6/W6/f79++fr169/7fI5PdIHAoAf0gMAIAAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsEgAASAAABIAAACwSAABIAAAEgAAALBIAAEgAAASAAAAsE/gG56uU7+ZidVwAAAABJRU5ErkJggg==';

        const imgT = new Image(); 
        imgT.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QYXCxw0W9YFvQAAAm9JREFUeNrtmztuwkAQhr8dEkU6SAs9AnIEpEInpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnpEAnv8H/gN0yYf1RkCg1gAAAABJRU5ErkJggg==';

        let world = 3000, isRunning = false;
        let p = { x: 1500, y: 1500, hp: 100, name: "", tool: "none", dir: 'down', hitting: false };
        let inv = { g: 0, w: 0, s: 0 };
        let ents = []; let mobs = [];
        let keys = {}; let joyDir = { x: 0, y: 0 };

        function initSfx() { 
            const m = document.getElementById('bgM'); 
            if(m.paused) { m.volume = 0.4; m.play().catch(()=>{}); }
        }

        function start() {
            p.name = document.getElementById('pName').value || "Hoang";
            // T·∫£i d·ªØ li·ªáu c≈© n·∫øu c√≥
            const saved = localStorage.getItem('necesse_save');
            if(saved) {
                const data = JSON.parse(saved);
                inv = data.inv; p.tool = data.tool;
            }
            document.getElementById('lobby').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui').style.display = 'block';
            resize(); initWorld();
            isRunning = true; updateUI();
            requestAnimationFrame(tick);
        }

        function saveGame() {
            const data = { inv: inv, tool: p.tool };
            localStorage.setItem('necesse_save', JSON.stringify(data));
            alert("ƒê√£ l∆∞u ti·∫øn tr√¨nh!");
        }

        function initWorld() {
            for(let i=0; i<80; i++) ents.push({x: Math.random()*world, y: Math.random()*world, type: Math.random()>0.5?'tree':'rock', hp: 50});
            for(let i=0; i<15; i++) mobs.push({x: Math.random()*world, y: Math.random()*world, hp: 40});
        }

        function hit() {
            if(!isRunning) return;
            document.getElementById('hitS').currentTime = 0;
            document.getElementById('hitS').play();
            p.hitting = true;
            ents.forEach((e, i) => {
                if(Math.hypot(p.x-e.x, p.y-e.y) < 100) {
                    let d = 10;
                    if(p.tool==='axe' && e.type==='tree') d=25;
                    e.hp -= d;
                    if(e.hp<=0) { if(e.type==='tree') inv.w+=5; else inv.s+=5; inv.g+=10; ents.splice(i,1); }
                }
            });
            updateUI();
            setTimeout(()=>p.hitting=false, 200);
        }

        function craft(t) {
            if(t==='axe' && inv.w>=15) { inv.w-=15; p.tool='axe'; }
            else if(t==='sword' && inv.w>=10 && inv.s>=10) { inv.w-=10; inv.s-=10; p.tool='sword'; }
            else { alert("Thi·∫øu nguy√™n li·ªáu!"); }
            updateUI();
        }

        function updateUI() {
            document.getElementById('g-v').innerText = inv.g;
            document.getElementById('w-v').innerText = inv.w;
            document.getElementById('s-v').innerText = inv.s;
            document.getElementById('t-v').innerText = p.tool.toUpperCase();
            document.getElementById('hp-bar').style.width = p.hp + "%";
        }

        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        const jb = document.getElementById('jb');
        jb.ontouchmove = e => {
            let t = e.touches[0], r = jb.getBoundingClientRect();
            let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            let d = Math.min(Math.sqrt(dx*dx+dy*dy), 50), a = Math.atan2(dy, dx);
            joyDir = { x: Math.cos(a)*(d/50), y: Math.sin(a)*(d/50) };
            document.getElementById('js').style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`;
        };
        jb.ontouchend = () => { joyDir = {x:0, y:0}; document.getElementById('js').style.transform = 'translate(-50%,-50%)'; };

        function tick() {
            if(!isRunning) return;
            let vx = joyDir.x, vy = joyDir.y;
            if(keys['KeyW']) vy = -1; if(keys['KeyS']) vy = 1;
            if(keys['KeyA']) vx = -1; if(keys['KeyD']) vx = 1;
            p.x = Math.max(0, Math.min(world, p.x + vx*6));
            p.y = Math.max(0, Math.min(world, p.y + vy*6));

            let cx = p.x - canvas.width/2, cy = p.y - canvas.height/2;
            ctx.fillStyle = '#2d6a4f'; ctx.fillRect(0,0, canvas.width, canvas.height);

            // V·∫Ω C√¢y/ƒê√°
            ents.forEach(e => {
                if(e.type === 'tree') ctx.drawImage(imgT, e.x-cx-30, e.y-cy-60, 60, 80);
                else { ctx.fillStyle='#7f8c8d'; ctx.beginPath(); ctx.ellipse(e.x-cx, e.y-cy, 20, 15, 0, 0, 7); ctx.fill(); }
            });

            // V·∫Ω Nh√¢n v·∫≠t
            ctx.fillStyle = p.hitting ? '#fff' : '#e67e22';
            ctx.fillRect(canvas.width/2-20, canvas.height/2-20, 40, 40);
            ctx.fillStyle = '#fff'; ctx.fillText(p.name, canvas.width/2-15, canvas.height/2-30);

            // Minimap
            mCtx.fillStyle = '#000'; mCtx.fillRect(0,0,120,120);
            mCtx.fillStyle = '#0f0'; mCtx.fillRect((p.x/world)*120, (p.y/world)*120, 4, 4);

            requestAnimationFrame(tick);
        }
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize;
    </script>
</body>
</html>
